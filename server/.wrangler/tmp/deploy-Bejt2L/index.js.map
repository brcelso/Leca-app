{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "C:\\Users\\celso\\Singularity\\Leca\\server\\.wrangler\\tmp\\deploy-Bejt2L",
  "sourcesContent": ["\n// Vanilla Worker Router - Zero Dependencies \uD83E\uDD42\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-User-Email',\n};\n\n// 0. Helper: Verify Google Token\nasync function verifyGoogleToken(token) {\n  if (!token || token === 'local-dev-token') return null;\n  try {\n    const res = await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${token}`);\n    if (!res.ok) return null;\n    const payload = await res.json();\n    return payload.email?.toLowerCase();\n  } catch (e) {\n    return null;\n  }\n}\n\nexport default {\n  async fetch(request, env, ctx) {\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    const url = new URL(request.url);\n    const path = url.pathname;\n\n    try {\n      // 1. Health Check\n      if (path === '/' || path === '') {\n        return new Response('Leca API v7.1 (Secure Checkout) - Online \uD83E\uDD42', {\n          headers: { ...corsHeaders, 'content-type': 'text/plain; charset=UTF-8' }\n        });\n      }\n\n      // Security Check: Get Token\n      const authHeader = request.headers.get('Authorization') || '';\n      const token = authHeader.replace('Bearer ', '');\n\n      // 2. Debug Endpoint (Secured)\n      if (path === '/api/debug' && request.method === 'GET') {\n        const verifiedEmail = await verifyGoogleToken(token);\n        const headerEmail = request.headers.get('X-User-Email') || url.searchParams.get('email');\n\n        // Strict Check: Only show debug for your own account\n        if (!verifiedEmail || verifiedEmail !== headerEmail?.toLowerCase()) {\n          return new Response('Unauthorized Debug Access', { status: 401, headers: corsHeaders });\n        }\n\n        let stats = {\n          tasks: null,\n          user_exists: false,\n          global: { total_tasks: 0, total_users: 0 }\n        };\n\n        const globalTasks = await env.DB.prepare('SELECT COUNT(*) as total FROM tasks').first();\n        const globalUsers = await env.DB.prepare('SELECT COUNT(*) as total FROM users').first();\n        stats.global.total_tasks = globalTasks?.total || 0;\n        stats.global.total_users = globalUsers?.total || 0;\n\n        if (verifiedEmail) {\n          const userRow = await env.DB.prepare('SELECT is_premium FROM users WHERE email = ?').bind(verifiedEmail).first();\n          stats.user_exists = !!userRow;\n          stats.is_premium = userRow?.is_premium === 1;\n          const count = await env.DB.prepare('SELECT COUNT(*) as total FROM tasks WHERE user_email = ?').bind(verifiedEmail).first();\n          stats.tasks = count?.total || 0;\n        }\n\n        return new Response(JSON.stringify({\n          status: 'online',\n          database: 'connected',\n          verified_user: verifiedEmail,\n          stats: stats,\n          server_time: new Date().toISOString()\n        }), {\n          headers: { ...corsHeaders, 'content-type': 'application/json' }\n        });\n      }\n\n      // 3. Login Endpoint\n      if (path === '/api/login' && request.method === 'POST') {\n        const verifiedEmail = await verifyGoogleToken(token);\n        let { email, name, picture } = await request.json();\n\n        if (!verifiedEmail || verifiedEmail !== email?.toLowerCase()) {\n          return new Response('Unauthorized Login attempt', { status: 401, headers: corsHeaders });\n        }\n\n        const emailLower = verifiedEmail;\n\n        await env.DB.prepare(`\n          INSERT INTO users (email, name, picture, last_login)\n          VALUES (?, ?, ?, CURRENT_TIMESTAMP)\n          ON CONFLICT(email) DO UPDATE SET\n            name = excluded.name,\n            picture = excluded.picture,\n            last_login = CURRENT_TIMESTAMP\n        `).bind(emailLower, name || null, picture || null).run();\n\n        return new Response(JSON.stringify({ success: true }), {\n          headers: { ...corsHeaders, 'content-type': 'application/json' }\n        });\n      }\n\n      // 3.1. AbacatePay Checkout Endpoint\n      if (path === '/api/checkout' && request.method === 'POST') {\n        const verifiedEmail = await verifyGoogleToken(token);\n        if (!verifiedEmail) {\n          return new Response('Unauthorized', { status: 401, headers: corsHeaders });\n        }\n\n        // Get user name from DB\n        const userRow = await env.DB.prepare('SELECT name FROM users WHERE email = ?').bind(verifiedEmail).first();\n        const userName = userRow?.name || 'Cliente Leca';\n\n        const apiKey = env.ABACATE_PAY_API_KEY;\n        if (!apiKey) {\n          return new Response('AbacatePay API Key not configured', { status: 500, headers: corsHeaders });\n        }\n\n        // Create Billing in AbacatePay\n        // Note: Field is 'price', NOT 'unitPrice'. Root 'amount' is not expected.\n        const abacateRes = await fetch('https://api.abacatepay.com/v1/billing/create', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${apiKey}`\n          },\n          body: JSON.stringify({\n            frequency: 'ONE_TIME',\n            methods: ['PIX'],\n            products: [{\n              externalId: 'leca_pro_lifetime',\n              name: 'Leca Pro - Acesso Vital\u00EDcio',\n              quantity: 1,\n              price: 1990 // R$ 19,90 (Cents)\n            }],\n            returnUrl: 'https://leca.celsosilva.com.br/',\n            completionUrl: 'https://leca.celsosilva.com.br/',\n            customer: {\n              name: userName,\n              email: verifiedEmail,\n              taxId: '36713044808', // Provided by user\n              cellphone: '11972509876'\n            }\n          })\n        });\n\n        let abacateData;\n        try {\n          abacateData = await abacateRes.json();\n        } catch (e) {\n          return new Response(JSON.stringify({ error: 'AbacatePay returned invalid JSON', status: abacateRes.status }), {\n            status: 500,\n            headers: corsHeaders\n          });\n        }\n\n        if (!abacateData) {\n          return new Response(JSON.stringify({ error: 'Empty response from AbacatePay' }), {\n            status: 500,\n            headers: corsHeaders\n          });\n        }\n\n        // Handle cases where API returns 200 but has an error field or fails validation\n        const hasError = !abacateRes.ok || abacateData.error;\n        if (hasError) {\n          return new Response(JSON.stringify({\n            error: abacateData.error || 'AbacatePay API Error',\n            details: abacateData\n          }), {\n            status: abacateRes.status || 400,\n            headers: corsHeaders\n          });\n        }\n\n        // Final check before accessing url\n        const checkoutUrl = abacateData.data?.url;\n        if (!checkoutUrl) {\n          return new Response(JSON.stringify({\n            error: 'Checkout URL not found in AbacatePay response',\n            details: abacateData\n          }), {\n            status: 500,\n            headers: corsHeaders\n          });\n        }\n\n        return new Response(JSON.stringify({ url: checkoutUrl }), {\n          headers: { ...corsHeaders, 'content-type': 'application/json' }\n        });\n      }\n\n      // 3.2. AbacatePay Webhook Endpoint\n      if (path === '/api/webhook/abacate' && request.method === 'POST') {\n        const body = await request.json();\n\n        // Em produ\u00E7\u00E3o, voc\u00EA deve verificar a assinatura do webhook aqui\n        // No modo dev, vamos apenas processar o evento de billing.paid\n        if (body.event === 'billing.paid') {\n          const email = body.data?.customer?.email;\n          if (email) {\n            await env.DB.prepare('UPDATE users SET is_premium = 1 WHERE email = ?')\n              .bind(email.toLowerCase())\n              .run();\n            console.log(`[AbacatePay] User ${email} upgraded to Premium!`);\n          }\n        }\n\n        return new Response('OK', { headers: corsHeaders });\n      }\n\n      // 4. Tasks Endpoints\n      if (path.startsWith('/api/tasks')) {\n        const verifiedEmail = await verifyGoogleToken(token);\n        const headerEmail = request.headers.get('X-User-Email');\n\n        if (!verifiedEmail || verifiedEmail !== headerEmail?.toLowerCase()) {\n          return new Response('Unauthorized - Invalid Token or Email Mismatch', { status: 401, headers: corsHeaders });\n        }\n\n        const emailLower = verifiedEmail;\n\n        // GET Tasks\n        if (request.method === 'GET') {\n          const { results } = await env.DB.prepare(\n            'SELECT * FROM tasks WHERE user_email = ? ORDER BY created_at DESC'\n          ).bind(emailLower).all();\n          return new Response(JSON.stringify(results), {\n            headers: { ...corsHeaders, 'content-type': 'application/json' }\n          });\n        }\n\n        // POST Tasks (Upsert)\n        if (request.method === 'POST') {\n          const body = await request.json();\n          const { uuid, name, targetFreq, completions } = body;\n\n          if (!uuid || !name) return new Response('Missing required fields', { status: 400, headers: corsHeaders });\n\n          await env.DB.prepare(`\n            INSERT INTO tasks (uuid, user_email, name, target_freq, completions, updated_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n            ON CONFLICT(uuid) DO UPDATE SET\n              name = excluded.name,\n              target_freq = excluded.target_freq,\n              completions = excluded.completions,\n              updated_at = excluded.updated_at\n          `).bind(\n            uuid, emailLower, name, targetFreq || 1,\n            JSON.stringify(completions || []),\n            new Date().toISOString()\n          ).run();\n\n          return new Response('OK', { headers: corsHeaders });\n        }\n\n        // DELETE Task\n        const match = path.match(/^\\/api\\/tasks\\/([^\\/]+)$/);\n        if (request.method === 'DELETE' && match) {\n          const uuid = match[1];\n          await env.DB.prepare('DELETE FROM tasks WHERE uuid = ? AND user_email = ?')\n            .bind(uuid, emailLower)\n            .run();\n          return new Response('Deleted', { headers: corsHeaders });\n        }\n      }\n\n      return new Response('Not Found', { status: 404, headers: corsHeaders });\n\n    } catch (err) {\n      console.error('[Worker Error]', err);\n      return new Response(JSON.stringify({ error: err.message }), {\n        status: 500,\n        headers: { ...corsHeaders, 'content-type': 'application/json' }\n      });\n    }\n  }\n};\n"],
  "mappings": "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",
  "names": []
}
